# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'
    
- script: |
    npm install -g npm
    npm cache clear --force

    npx @microsoft/rush update
    rc=$?; if [ $rc -ne 0 ]; then exit $rc ; fi
    npx @microsoft/rush rebuild
    rc=$?; if [ $rc -ne 0 ]; then exit $rc ; fi
    npx @microsoft/rush test
    rc=$?; if [ $rc -ne 0 ]; then exit $rc ; fi

    # set the actual package versions
    npx @microsoft/rush set-versions
    rc=$?; if [ $rc -ne 0 ]; then exit $rc ; fi 

    npx @microsoft/rush publish --publish --pack --include-all --tag latest
    rc=$?; if [ $rc -ne 0 ]; then exit $rc ; fi 

    v=`node -e "console.log(require('modelerfour/package.json').version)"`
    echo "##vso[task.setvariable variable=artver]$v"

  displayName: 'Rush install, build and test'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Pipeline.Workspace)/common/temp/artifacts/packages/autorest-modelerfour-$(artver).tgz'
    artifact: 'v$(artver)'
    publishLocation: 'pipeline'

- task: GitHubComment@0
  inputs:
    gitHubConnection: 'Azure'
    repositoryName: '$(Build.Repository.Name)'
    comment: 'PR pkg created: $(artver)'

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- script: npm install -g @autorest/compare@~0.3.0
  displayName: Install autorest-compare

- script: autorest-compare --compare:.scripts/regression-compare.yaml --language:python
  displayName: Regression Test - @autorest/python
